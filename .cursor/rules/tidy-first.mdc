---
description: Tidy First原則に基づくコード整理とリファクタリング
globs: ["**/*.py", "**/*.ts", "**/*.tsx", "**/*.js"]
alwaysApply: false
---

# Tidy First 原則

## Tidy Firstとは

「Tidy First」は、Kent Beckが提唱する開発手法で、**機能追加やバグ修正の前に、まずコードを整理（Tidy）する**という原則です。

## 基本原則

### 1. 変更前に整理する

新しい機能を追加する前に、変更対象のコードを整理します。

**理由**:
- 整理されたコードは理解しやすい
- バグが発生しにくい
- 変更が容易になる

### 2. 小さな変更を積み重ねる

大きな変更を一度に行わず、小さな変更を積み重ねます。

**理由**:
- リスクが低い
- レビューが容易
- 問題の特定が簡単

### 3. テストを書いてから変更する

リファクタリング前にテストを書きます。

**理由**:
- 動作が変わっていないことを確認できる
- リファクタリングの安全性が向上

## Tidy Firstの実践

### コード整理の優先順位

1. **重複の削除（DRY原則）**
   - 同じコードが複数箇所にある場合は、関数やクラスに抽出
   - 共通処理はユーティリティ関数に

2. **命名の改善**
   - 変数名、関数名、クラス名を明確に
   - 意図が伝わる名前を選ぶ

3. **関数の分割**
   - 長い関数を小さな関数に分割
   - 単一責任の原則（SRP）に従う

4. **コメントの追加・改善**
   - 複雑なロジックには説明を追加
   - 古いコメントを削除

5. **型ヒントの追加**
   - Python: 型ヒントを追加
   - TypeScript: 型定義を明確に

### 実践例

#### 例1: 重複コードの削除

**Before**:
```python
# 複数箇所で同じ処理が重複
if log_level == "ERROR":
    print(f"[ERROR] {message}")
elif log_level == "WARNING":
    print(f"[WARNING] {message}")
```

**After**:
```python
# 共通関数に抽出
def log_message(level: str, message: str):
    print(f"[{level}] {message}")
```

#### 例2: 関数の分割

**Before**:
```python
def process_logs(logs):
    # 100行以上の長い関数
    # 複数の責任を持っている
    ...
```

**After**:
```python
def filter_logs(logs, level):
    # フィルタリングのみ
    ...

def format_logs(logs):
    # フォーマットのみ
    ...

def process_logs(logs):
    # 処理のオーケストレーション
    filtered = filter_logs(logs, "ERROR")
    return format_logs(filtered)
```

#### 例3: 命名の改善

**Before**:
```python
def proc(data):
    # 何を処理するのか不明
    ...
```

**After**:
```python
def process_elasticsearch_logs(log_entries: List[LogEntry]) -> List[FormattedLog]:
    # 処理内容が明確
    ...
```

## Tidy Firstのチェックリスト

### 機能追加前

- [ ] 変更対象のコードを理解しているか
- [ ] 重複コードがないか確認
- [ ] テストが書かれているか
- [ ] 命名が適切か

### バグ修正前

- [ ] バグの原因を特定できているか
- [ ] 関連するコードを整理する必要はないか
- [ ] テストを追加できるか

### リファクタリング時

- [ ] テストが書かれているか
- [ ] 小さな変更に分割できるか
- [ ] 動作が変わっていないことを確認できるか

## 注意事項

### Tidy Firstを適用しない場合

以下の場合は、Tidy Firstを適用しないこともあります：

1. **緊急のバグ修正**
   - 本番環境で重大な問題が発生している場合
   - まず修正を優先し、後で整理

2. **プロトタイプ開発**
   - 実験的な機能開発
   - まず動作確認を優先

3. **既存コードの大規模変更**
   - 段階的に整理を進める
   - 一度にすべてを整理しようとしない

### Tidy Firstの効果

- **コードの可読性向上**
- **バグの減少**
- **開発速度の向上**
- **保守性の向上**

## 実践のコツ

1. **小さく始める**
   - 1つの関数、1つのクラスから
   - 完璧を目指さない

2. **継続的に整理する**
   - 毎日の開発で少しずつ
   - 技術的負債を蓄積しない

3. **チームで共有する**
   - 整理の基準を統一
   - コードレビューで確認

この原則に従って、高品質で保守しやすいコードを維持してください。
