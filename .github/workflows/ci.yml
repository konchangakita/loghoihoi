name: CI - Complete (build & validate)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  packages: write  # GitHub Container Registryã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã«å¿…è¦
  actions: read    # Helmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ—ãƒƒã‚·ãƒ¥ã«å¿…è¦
  id-token: write  # OIDCãƒˆãƒ¼ã‚¯ãƒ³èªè¨¼ã«å¿…è¦

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      syslog: ${{ steps.filter.outputs.syslog }}
      helm: ${{ steps.filter.outputs.helm }}
      compose: ${{ steps.filter.outputs.compose }}
    steps:
      - uses: actions/checkout@v4

      - name: Paths filter
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            # NOTE: shared/ ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å°‚ç”¨ï¼ˆPythonã‚³ãƒ¼ãƒ‰ã®ã¿ï¼‰ã®ãŸã‚ã€frontend filter ã«ã¯å«ã‚ãªã„
            frontend:
              - 'frontend/**'

            # NOTE: Dockerfileã®globã‚’çµã£ã¦ã€Œé–¢ä¿‚ãªã„Dockerfileå¤‰æ›´ã€ã§ç„¡é§„ã«èµ°ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
            backend:
              - 'backend/**'
              - 'shared/**'              # sharedãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ã‚‚backendã«å½±éŸ¿
              - 'backend/Dockerfile*'
              - 'Dockerfile*'            # ãƒ«ãƒ¼ãƒˆDockerfileã«ä¾å­˜ã—ã¦ã„ã‚‹å ´åˆã ã‘æ®‹ã™ï¼ˆä¸è¦ãªã‚‰å‰Šé™¤OKï¼‰
              - '.dockerignore'          # ãƒ“ãƒ«ãƒ‰çµæœã«å½±éŸ¿ã™ã‚‹ãŸã‚

            syslog:
              - 'syslog/**'
              - 'syslog/Dockerfile*'
              - '.dockerignore'

            helm:
              - 'helm/**'
              - 'k8s/**'

            compose:
              - 'docker-compose.yml'
              - 'docker-compose.*.yml'

  build-frontend:
    name: Build frontend (yarn build)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    defaults:
      run:
        working-directory: frontend/next-app/loghoi

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: frontend/next-app/loghoi/yarn.lock

      - name: Enable Corepack
        run: corepack enable

      - name: Show versions
        run: |
          node -v
          yarn -v

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build
        run: yarn build

  build-backend:
    name: Build backend (docker build only)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Build backend Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: backend/Dockerfile.k8s
          push: false
          tags: loghoi-backend:ci-test

  build-syslog:
    name: Build syslog (docker build only)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.syslog == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Build syslog Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./syslog
          file: ./syslog/Dockerfile.k8s
          push: false
          tags: loghoi-syslog:ci-test

  validate-packaging:
    name: Validate compose/helm (lint & template)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.helm == 'true' || needs.changes.outputs.compose == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Validate docker compose (config)
        if: needs.changes.outputs.compose == 'true'
        run: |
          docker version
          docker compose version
          docker compose -f docker-compose.yml config -q

      # NOTE: Compose buildã¯é‡ããªã‚ŠãŒã¡ãªã®ã§ã€pushæ™‚ã®ã¿å®Ÿæ–½ï¼ˆPRã¯æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã«ç•™ã‚ã‚‹ï¼‰
      - name: Validate docker compose (build on push)
        if: needs.changes.outputs.compose == 'true' && github.event_name == 'push'
        run: |
          # ã‚µãƒ¼ãƒ“ã‚¹åä¸ä¸€è‡´äº‹æ•…ã‚’é¿ã‘ã‚‹ãŸã‚ã€å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ“ãƒ«ãƒ‰ä¸è¦ãªã‚µãƒ¼ãƒ“ã‚¹ã¯è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          docker compose -f docker-compose.yml build

      - name: Setup Helm
        if: needs.changes.outputs.helm == 'true'
        uses: azure/setup-helm@v4
        # NOTE: version ã‚’æŒ‡å®šã—ãªã„ã¨å®‰å®šã—ãŸæœ€æ–°ãŒå…¥ã‚‹ã“ã¨ãŒå¤šã„ï¼ˆlatestæŒ‡å®šã¯é€†ã«ãƒ–ãƒ¬ã®åŸå› ã«ãªã‚ŠãŒã¡ï¼‰

      - name: Helm lint & template
        if: needs.changes.outputs.helm == 'true'
        run: |
          helm version
          helm lint ./helm/loghoihoi
          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
          helm template loghoihoi ./helm/loghoihoi >/dev/null
          # values.yamlã§ã‚‚ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆvaluesã§å£Šã‚Œã‚‹ã®ã‚’æ¤œå‡ºï¼‰
          helm template loghoihoi ./helm/loghoihoi -f ./helm/loghoihoi/values.yaml >/dev/null

  # CD: mainãƒ–ãƒ©ãƒ³ãƒãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥
  build-push-frontend:
    name: Build & Push frontend image
    runs-on: ubuntu-latest
    needs: [changes, build-frontend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.changes.outputs.frontend == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/konchangakita/loghoi-frontend
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push frontend Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend/next-app/loghoi
          file: ./frontend/next-app/loghoi/Dockerfile.k8s
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-push-backend:
    name: Build & Push backend image
    runs-on: ubuntu-latest
    needs: [changes, build-backend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.changes.outputs.backend == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/loghoi-backend
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push backend Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./backend/Dockerfile.k8s
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  build-push-syslog:
    name: Build & Push syslog image
    runs-on: ubuntu-latest
    needs: [changes, build-syslog]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.changes.outputs.syslog == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/konchangakita/loghoi-syslog
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push syslog Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./syslog
          file: ./syslog/Dockerfile.k8s
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # CD: Helmãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥
  build-push-helm:
    name: Build & Push Helm package
    runs-on: ubuntu-latest
    needs: [changes]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.changes.outputs.helm == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Login to GitHub Container Registry  
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Login to Helm registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io --username ${{ github.actor }} --password-stdin

      - name: Package and Push Helm Chart
        run: |
          # Chart version ã‚’æ›´æ–°ï¼ˆsemantic versioningï¼‰
          CHART_VERSION="0.1.${{ github.run_number }}"
          
          echo "ğŸ”§ Updating Chart version to: ${CHART_VERSION}"
          
          # values.yamlã§latestã‚¿ã‚°ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«appVersionã‚‚æ›´æ–°
          sed -i "s/^version:.*/version: ${CHART_VERSION}/" helm/loghoihoi/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: latest/" helm/loghoihoi/Chart.yaml
          
          echo "ğŸ“‹ Updated Chart.yaml:"
          cat helm/loghoihoi/Chart.yaml
          
          # Helm chart ã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–
          echo "ğŸ“¦ Packaging Helm chart..."
          helm package helm/loghoihoi --destination ./helm-packages
          
          echo "ğŸ“‚ Package contents:"
          ls -la ./helm-packages/
          
          # GitHub Actor ã¨æ¨©é™ã®ç¢ºèª
          echo "ğŸ‘¤ GitHub Actor: ${{ github.actor }}"
          echo "ğŸ”‘ Registry: ghcr.io"
          
          # è¤‡æ•°ã®ãƒ—ãƒƒã‚·ãƒ¥å…ˆã‚’è©¦è¡Œ
          echo "ğŸš€ Attempting to push Helm chart..."
          
          # GitHub Container Registryã«æ­£ã—ã„ãƒ‘ã‚¹ã§ãƒ—ãƒƒã‚·ãƒ¥
          TARGET_PATH="oci://ghcr.io/konchangakita/loghoihoi"
          echo "ğŸ“¤ Pushing to: ${TARGET_PATH}"
          
          helm push ./helm-packages/loghoihoi-${CHART_VERSION}.tgz ${TARGET_PATH}
          echo "âœ… Successfully pushed to ghcr.io/konchangakita/loghoihoi:${CHART_VERSION}"

  # å¤‰æ›´ãŒãªã„å ´åˆã§ã‚‚ã€ŒCIãŒæˆåŠŸæ‰±ã„ã€ã«ãªã‚‹ã‚ˆã†ã€æœ€å¾Œã«é›†ç´„ã‚¸ãƒ§ãƒ–ã‚’ç½®ã
  ci-summary:
    name: CI summary
    runs-on: ubuntu-latest
    needs:
      - changes
      - build-frontend
      - build-backend
      - build-syslog
      - validate-packaging
      - build-push-frontend
      - build-push-backend
      - build-push-syslog
      - build-push-helm
    if: always()
    steps:
      - name: Check CI results
        shell: bash
        run: |
          set -e

          echo "=== Change Detection ==="
          echo "frontend changed:   ${{ needs.changes.outputs.frontend }}"
          echo "backend changed:    ${{ needs.changes.outputs.backend }}"
          echo "syslog changed:     ${{ needs.changes.outputs.syslog }}"
          echo "helm changed:       ${{ needs.changes.outputs.helm }}"
          echo "compose changed:    ${{ needs.changes.outputs.compose }}"
          echo ""
          echo "=== Job Results ==="
          echo "build-frontend:     ${{ needs.build-frontend.result }}"
          echo "build-backend:      ${{ needs.build-backend.result }}"
          echo "build-syslog:       ${{ needs.build-syslog.result }}"
          echo "validate-packaging: ${{ needs.validate-packaging.result }}"
          echo ""
          echo "=== CD Results (main branch only) ==="
          echo "push-frontend:      ${{ needs.build-push-frontend.result }}"
          echo "push-backend:       ${{ needs.build-push-backend.result }}"
          echo "push-syslog:        ${{ needs.build-push-syslog.result }}"
          echo "push-helm:          ${{ needs.build-push-helm.result }}"
          echo ""

          failed_jobs=()

          # failure/cancelled ã¯å¤±æ•—æ‰±ã„
          if [ "${{ needs.build-frontend.result }}" = "failure" ] || [ "${{ needs.build-frontend.result }}" = "cancelled" ]; then failed_jobs+=("build-frontend"); fi
          if [ "${{ needs.build-backend.result }}"  = "failure" ] || [ "${{ needs.build-backend.result }}"  = "cancelled" ]; then failed_jobs+=("build-backend"); fi
          if [ "${{ needs.build-syslog.result }}"   = "failure" ] || [ "${{ needs.build-syslog.result }}"   = "cancelled" ]; then failed_jobs+=("build-syslog"); fi
          if [ "${{ needs.validate-packaging.result }}" = "failure" ] || [ "${{ needs.validate-packaging.result }}" = "cancelled" ]; then failed_jobs+=("validate-packaging"); fi
          
          # CD ã‚¸ãƒ§ãƒ–ã‚‚å¤±æ•—ã‚’ãƒã‚§ãƒƒã‚¯
          if [ "${{ needs.build-push-frontend.result }}" = "failure" ] || [ "${{ needs.build-push-frontend.result }}" = "cancelled" ]; then failed_jobs+=("build-push-frontend"); fi
          if [ "${{ needs.build-push-backend.result }}"  = "failure" ] || [ "${{ needs.build-push-backend.result }}"  = "cancelled" ]; then failed_jobs+=("build-push-backend"); fi
          if [ "${{ needs.build-push-syslog.result }}"   = "failure" ] || [ "${{ needs.build-push-syslog.result }}"   = "cancelled" ]; then failed_jobs+=("build-push-syslog"); fi
          if [ "${{ needs.build-push-helm.result }}"     = "failure" ] || [ "${{ needs.build-push-helm.result }}"     = "cancelled" ]; then failed_jobs+=("build-push-helm"); fi

          # å¤‰æ›´ãŒã‚ã£ãŸã®ã«skippedã¯NGï¼ˆifæ¡ä»¶ãƒŸã‚¹æ¤œçŸ¥ï¼‰
          if [ "${{ needs.changes.outputs.frontend }}" = "true" ] && [ "${{ needs.build-frontend.result }}" = "skipped" ]; then failed_jobs+=("build-frontend(skipped-unexpected)"); fi
          if [ "${{ needs.changes.outputs.backend }}"  = "true" ] && [ "${{ needs.build-backend.result }}"  = "skipped" ]; then failed_jobs+=("build-backend(skipped-unexpected)"); fi
          if [ "${{ needs.changes.outputs.syslog }}"   = "true" ] && [ "${{ needs.build-syslog.result }}"   = "skipped" ]; then failed_jobs+=("build-syslog(skipped-unexpected)"); fi

          packaging_changed="false"
          if [ "${{ needs.changes.outputs.helm }}" = "true" ] || [ "${{ needs.changes.outputs.compose }}" = "true" ]; then packaging_changed="true"; fi
          if [ "$packaging_changed" = "true" ] && [ "${{ needs.validate-packaging.result }}" = "skipped" ]; then failed_jobs+=("validate-packaging(skipped-unexpected)"); fi

          if [ ${#failed_jobs[@]} -gt 0 ]; then
            echo "âŒ CI failed. Issues: ${failed_jobs[*]}"
            exit 1
          fi

          # æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è©³ç´°åŒ–
          cd_executed="false"
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            cd_executed="true"
          fi
          
          if [ "$cd_executed" = "true" ]; then
            echo "âœ… CI/CD passed. All jobs succeeded and container images + helm packages were pushed to ghcr.io."
          else
            echo "âœ… CI passed. All required jobs succeeded; others were skipped as expected."
          fi


